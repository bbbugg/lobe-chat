name: Upstream Sync

permissions:
  contents: write
  issues: write
  actions: write

on:
  schedule:
    - cron: '0 */6 * * *' # æ¯ 6 å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync_latest_from_upstream:
    name: Sync latest commits from upstream repo  # åŒæ­¥ä¸Šæ¸¸ä»“åº“çš„æœ€æ–°æäº¤
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork }}  # ä»…åœ¨ fork ä»“åº“ä¸­è¿è¡Œ

    steps:
      - uses: actions/checkout@v5
        with:
          token: ${{ secrets.MY_PAT }}  # ä½¿ç”¨ PAT ç¡®ä¿åç»­ git æ“ä½œæœ‰æƒé™
          ref: next  # æ˜ç¡®æ£€å‡º next åˆ†æ”¯
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œä¾¿äº merge æ“ä½œ

      - name: Clean issue notice  # æ¸…ç†ä¹‹å‰çš„å¤±è´¥ issue
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'close-issues'
          labels: 'ğŸš¨ Sync Fail'

      # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
      - name: Setup Git User
        run: |
          git config --global user.name "bbbugg"
          git config --global user.email "daming20120101@163.com"

      # æ‰‹åŠ¨åŒæ­¥ä¸Šæ¸¸å˜æ›´ï¼ˆä½¿ç”¨ merge ç­–ç•¥ï¼‰
      - name: Manual Sync upstream changes
        run: |
          set -e  # ä¸¥æ ¼æ¨¡å¼ï¼šä»»ä½•å‘½ä»¤å¤±è´¥å³é€€å‡º
          # æ·»åŠ ä¸Šæ¸¸ remoteï¼ˆå¦‚æœå·²å­˜åœ¨åˆ™å¿½ç•¥ï¼‰
          git remote add upstream https://github.com/lobehub/lobe-chat.git || true
          # è·å–ä¸Šæ¸¸æœ€æ–°å˜æ›´
          git fetch upstream next
          # åˆ‡æ¢åˆ°ç›®æ ‡åˆ†æ”¯
          git checkout next
          # æ˜¾å¼ mergeï¼ˆ--no-ff å¼ºåˆ¶åˆ›å»º merge commitï¼Œ-m è‡ªå®šä¹‰æ¶ˆæ¯ï¼‰
          git merge upstream/next --no-ff -m "Action: è‡ªåŠ¨åŒæ­¥ä¸Šæ¸¸ä»£ç "
          # æ£€æŸ¥æ˜¯å¦æœ‰å†²çªï¼ˆunmerged pathsï¼‰
          if git diff --name-only --diff-filter=U | grep -q . ; then
            echo "Merge conflict detected. Files need manual resolution:"
            git diff --name-only --diff-filter=U  # è¾“å‡ºå†²çªæ–‡ä»¶ï¼Œä¾¿äºæ—¥å¿—æŸ¥çœ‹
            exit 1  # æ˜ç¡®å¤±è´¥ï¼Œè§¦å‘ issue
          fi
          # æ— å†²çªï¼šå·²è‡ªåŠ¨ commit

          # æ¨é€ç›®æ ‡åˆ†æ”¯ï¼ˆç²¾ç¡® refï¼Œç¡®ä¿ --force-with-lease å®‰å…¨ï¼‰
          git push origin next --force-with-lease=next:origin/next

      # åŒæ­¥æ£€æŸ¥ï¼šå¦‚æœå¤±è´¥ï¼Œåˆ›å»º issue
      - name: Sync check
        if: failure()
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-issue'
          title: 'ğŸš¨ åŒæ­¥å¤±è´¥ | Sync Fail'
          labels: 'ğŸš¨ Sync Fail'
          body: |
            Due to a change in the workflow file of the [LobeChat][lobechat] upstream repository, GitHub has automatically suspended the scheduled automatic update. You need to manually sync your fork. Please refer to the detailed [Tutorial][tutorial-en-US] for instructions.

            ç”±äº [LobeChat][lobechat] ä¸Šæ¸¸ä»“åº“çš„ workflow æ–‡ä»¶å˜æ›´ï¼Œå¯¼è‡´ GitHub è‡ªåŠ¨æš‚åœäº†æœ¬æ¬¡è‡ªåŠ¨æ›´æ–°ï¼Œä½ éœ€è¦æ‰‹åŠ¨ Sync Fork ä¸€æ¬¡ï¼Œè¯·æŸ¥çœ‹ [è¯¦ç»†æ•™ç¨‹][tutorial-zh-CN]

            ![](https://github-production-user-asset-6210df.s3.amazonaws.com/17870709/273954625-df80c890-0822-4ac2-95e6-c990785cbed5.png)

            [lobechat]: https://github.com/lobehub/lobe-chat
            [tutorial-zh-CN]: https://lobehub.com/zh/docs/self-hosting/advanced/upstream-sync
            [tutorial-en-US]: https://lobehub.com/docs/self-hosting/advanced/upstream-sync
